<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - POS System</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="sidebar">
        <div class="nav-brand">POS System</div>
        <nav class="nav">
            <a href="/dashboard" class="nav-item">ðŸ“Š Dashboard</a>
            <a href="/products" class="nav-item active">ðŸ“¦ Products</a>
            <a href="/transactions" class="nav-item">ðŸ’³ Transactions</a>
            <a href="/reports" class="nav-item">ðŸ“ˆ Reports</a>
            <a href="#" class="nav-item" onclick="auth.logout()">ðŸšª Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Product Management</h1>
            <div class="flex items-center gap-4">
                <button class="btn btn-primary" onclick="showProductModal()">+ Add Product</button>
                <button class="btn btn-secondary" onclick="showCategoryModal()">+ Add Category</button>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="flex gap-4 items-center">
                <div class="form-group mb-0">
                    <input type="text" id="searchInput" class="form-input" placeholder="Search products..." style="width: 300px;">
                </div>
                <div class="form-group mb-0">
                    <select id="categoryFilter" class="form-select" style="width: 200px;">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="form-group mb-0">
                    <select id="stockFilter" class="form-select" style="width: 150px;">
                        <option value="">All Stock</option>
                        <option value="low">Low Stock</option>
                        <option value="out">Out of Stock</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="card">
            <table class="table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>SKU</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    <tr>
                        <td colspan="6" class="text-center">Loading products...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Add Product</h3>
                <button class="btn btn-secondary btn-sm" onclick="hideProductModal()">Ã—</button>
            </div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label for="productName" class="form-label">Product Name</label>
                    <input type="text" id="productName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="productDescription" class="form-label">Description</label>
                    <textarea id="productDescription" class="form-textarea"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="productPrice" class="form-label">Price</label>
                        <input type="number" id="productPrice" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productStock" class="form-label">Stock</label>
                        <input type="number" id="productStock" class="form-input" min="0" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="productCategory" class="form-label">Category</label>
                        <select id="productCategory" class="form-select">
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productSku" class="form-label">SKU</label>
                        <input type="text" id="productSku" class="form-input">
                    </div>
                </div>
                <div class="flex gap-2 justify-end">
                    <button type="button" class="btn btn-secondary" onclick="hideProductModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Category</h3>
                <button class="btn btn-secondary btn-sm" onclick="hideCategoryModal()">Ã—</button>
            </div>
            <form id="categoryForm">
                <div class="form-group">
                    <label for="categoryName" class="form-label">Category Name</label>
                    <input type="text" id="categoryName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="categoryDescription" class="form-label">Description</label>
                    <textarea id="categoryDescription" class="form-textarea"></textarea>
                </div>
                <div class="flex gap-2 justify-end">
                    <button type="button" class="btn btn-secondary" onclick="hideCategoryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Category</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .stock-low {
            color: var(--color-warning);
            font-weight: 500;
        }

        .stock-out {
            color: var(--color-error);
            font-weight: 500;
        }
    </style>

    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script>
        // Check authentication
        if (!auth.requireAuth()) {
            // Will redirect to login if not authenticated
        }

        let products = [];
        let categories = [];
        let filteredProducts = [];

        // Load initial data
        async function loadData() {
            try {
                [products, categories] = await Promise.all([
                    api.getProducts(),
                    api.getCategories()
                ]);
                
                filteredProducts = [...products];
                renderProducts();
                populateCategoryFilters();
            } catch (error) {
                console.error('Failed to load data:', error);
                showAlert('Failed to load products', 'error');
            }
        }

        function renderProducts() {
            const tbody = document.getElementById('productsTableBody');
            
            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No products found</td></tr>';
                return;
            }

            const rows = filteredProducts.map(product => {
                const stockClass = product.stock === 0 ? 'stock-out' : product.stock < 10 ? 'stock-low' : '';
                const stockText = product.stock === 0 ? 'Out of Stock' : product.stock;
                
                return `
                    <tr>
                        <td>
                            <div class="font-medium">${product.name}</div>
                            <div class="text-sm text-muted">${product.description || 'No description'}</div>
                        </td>
                        <td>${product.category_name || 'No category'}</td>
                        <td>${formatCurrency(product.price)}</td>
                        <td class="${stockClass}">${stockText}</td>
                        <td class="text-sm">${product.sku || 'N/A'}</td>
                        <td>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary btn-sm" onclick="editProduct(${product.id})">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function populateCategoryFilters() {
            const categoryFilter = document.getElementById('categoryFilter');
            const productCategory = document.getElementById('productCategory');
            
            const categoryOptions = categories.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');
            
            categoryFilter.innerHTML = '<option value="">All Categories</option>' + categoryOptions;
            productCategory.innerHTML = '<option value="">Select Category</option>' + categoryOptions;
        }

        // Filter functions
        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryId = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;

            filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                                    (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                                    (product.sku && product.sku.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryId || product.category_id == categoryId;
                
                let matchesStock = true;
                if (stockFilter === 'low') {
                    matchesStock = product.stock > 0 && product.stock < 10;
                } else if (stockFilter === 'out') {
                    matchesStock = product.stock === 0;
                }

                return matchesSearch && matchesCategory && matchesStock;
            });

            renderProducts();
        }

        // Event listeners for filters
        document.getElementById('searchInput').addEventListener('input', debounce(filterProducts, 300));
        document.getElementById('categoryFilter').addEventListener('change', filterProducts);
        document.getElementById('stockFilter').addEventListener('change', filterProducts);

        // Product modal functions
        function showProductModal(productId = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            const form = document.getElementById('productForm');
            
            form.reset();
            document.getElementById('productId').value = '';
            
            if (productId) {
                title.textContent = 'Edit Product';
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productCategory').value = product.category_id || '';
                    document.getElementById('productSku').value = product.sku || '';
                }
            } else {
                title.textContent = 'Add Product';
            }
            
            modal.style.display = 'flex';
        }

        function hideProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        function editProduct(id) {
            showProductModal(id);
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                await api.deleteProduct(id);
                showAlert('Product deleted successfully', 'success');
                loadData();
            } catch (error) {
                console.error('Failed to delete product:', error);
                showAlert('Failed to delete product', 'error');
            }
        }

        // Product form submission
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const productData = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                category_id: document.getElementById('productCategory').value || null,
                sku: document.getElementById('productSku').value
            };

            try {
                if (productId) {
                    await api.updateProduct(productId, productData);
                    showAlert('Product updated successfully', 'success');
                } else {
                    await api.createProduct(productData);
                    showAlert('Product created successfully', 'success');
                }
                
                hideProductModal();
                loadData();
            } catch (error) {
                console.error('Failed to save product:', error);
                showAlert('Failed to save product', 'error');
            }
        });

        // Category modal functions
        function showCategoryModal() {
            document.getElementById('categoryModal').style.display = 'flex';
        }

        function hideCategoryModal() {
            document.getElementById('categoryModal').style.display = 'none';
            document.getElementById('categoryForm').reset();
        }

        // Category form submission
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const categoryData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value
            };

            try {
                await api.createCategory(categoryData);
                showAlert('Category created successfully', 'success');
                hideCategoryModal();
                
                // Reload categories and update filters
                categories = await api.getCategories();
                populateCategoryFilters();
            } catch (error) {
                console.error('Failed to create category:', error);
                showAlert('Failed to create category', 'error');
            }
        });

        // Close modals when clicking outside
        document.getElementById('productModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                hideProductModal();
            }
        });

        document.getElementById('categoryModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                hideCategoryModal();
            }
        });

        // Load data on page load
        loadData();
    </script>
</body>
</html>
