<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - POS System</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="sidebar">
        <div class="nav-brand">POS System</div>
        <nav class="nav">
            <a href="/dashboard" class="nav-item active">üìä Dashboard</a>
            <a href="/products" class="nav-item">üì¶ Products</a>
            <a href="/transactions" class="nav-item">üí≥ Transactions</a>
            <a href="/reports" class="nav-item">üìà Reports</a>
            <a href="#" class="nav-item" onclick="auth.logout()">üö™ Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Dashboard</h1>
            <div class="flex items-center gap-4">
                <span class="text-sm text-muted">Welcome, <span id="userName">Admin</span></span>
                <button class="btn btn-secondary btn-sm" onclick="location.reload()">üîÑ Refresh</button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-4 mb-4">
            <div class="stat-card">
                <div class="stat-value" id="todaySales">$0.00</div>
                <div class="stat-label">Today's Sales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthlySales">$0.00</div>
                <div class="stat-label">Monthly Sales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lowStockCount">0</div>
                <div class="stat-label">Low Stock Items</div>
            </div>
        </div>

        <div class="grid grid-cols-2">
            <!-- Recent Sales -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent Sales</h3>
                    <p class="card-description">Latest transactions</p>
                </div>
                <div id="recentSalesContainer">
                    <div class="text-center">Loading...</div>
                </div>
            </div>

            <!-- Best Selling Products -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Best Selling Products</h3>
                    <p class="card-description">Top performers this month</p>
                </div>
                <div id="bestSellingContainer">
                    <div class="text-center">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Low Stock Alert -->
        <div class="card" id="lowStockCard" style="display: none;">
            <div class="card-header">
                <h3 class="card-title">‚ö†Ô∏è Low Stock Alert</h3>
                <p class="card-description">Products running low on inventory</p>
            </div>
            <div id="lowStockContainer"></div>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script>
        // Check authentication
        if (!auth.requireAuth()) {
            // Will redirect to login if not authenticated
        }

        // Set user name
        const user = auth.getUser();
        if (user) {
            document.getElementById('userName').textContent = user.name;
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                const stats = await api.getDashboardStats();
                
                // Update stats cards
                document.getElementById('todaySales').textContent = formatCurrency(stats.todaySales);
                document.getElementById('monthlySales').textContent = formatCurrency(stats.monthlySales);
                document.getElementById('totalProducts').textContent = stats.totalProducts;
                document.getElementById('lowStockCount').textContent = stats.lowStockProducts.length;

                // Load recent sales
                loadRecentSales(stats.recentSales);

                // Load best selling products
                loadBestSelling(stats.bestSelling);

                // Load low stock products
                loadLowStock(stats.lowStockProducts);

            } catch (error) {
                console.error('Failed to load dashboard:', error);
                showAlert('Failed to load dashboard data', 'error');
            }
        }

        function loadRecentSales(sales) {
            const container = document.getElementById('recentSalesContainer');
            
            if (!sales || sales.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No recent sales</p>';
                return;
            }

            const salesHTML = sales.map(sale => `
                <div class="flex justify-between items-center" style="padding: 0.75rem 0; border-bottom: 1px solid var(--color-border);">
                    <div>
                        <div class="font-medium">Sale #${sale.id}</div>
                        <div class="text-sm text-muted">${formatDate(sale.created_at)}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-medium">${formatCurrency(sale.total_amount)}</div>
                        <div class="text-sm text-muted">${sale.payment_method}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = salesHTML;
        }

        function loadBestSelling(products) {
            const container = document.getElementById('bestSellingContainer');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No sales data</p>';
                return;
            }

            const productsHTML = products.map(product => `
                <div class="flex justify-between items-center" style="padding: 0.75rem 0; border-bottom: 1px solid var(--color-border);">
                    <div>
                        <div class="font-medium">${product.name}</div>
                        <div class="text-sm text-muted">${product.total_sold} sold</div>
                    </div>
                    <div class="text-right">
                        <div class="font-medium">${formatCurrency(product.revenue)}</div>
                        <div class="text-sm text-muted">${formatCurrency(product.price)} each</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = productsHTML;
        }

        function loadLowStock(products) {
            const container = document.getElementById('lowStockContainer');
            const card = document.getElementById('lowStockCard');
            
            if (!products || products.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';

            const productsHTML = products.map(product => `
                <div class="flex justify-between items-center" style="padding: 0.75rem 0; border-bottom: 1px solid var(--color-border);">
                    <div>
                        <div class="font-medium">${product.name}</div>
                        <div class="text-sm text-muted">${product.category_name || 'No category'}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-medium text-warning">${product.stock} left</div>
                        <div class="text-sm text-muted">${formatCurrency(product.price)}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = productsHTML;
        }

        // Load dashboard on page load
        loadDashboard();

        // Auto-refresh every 5 minutes
        setInterval(loadDashboard, 5 * 60 * 1000);
    </script>
</body>
</html>
